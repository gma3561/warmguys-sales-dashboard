<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë”°ìŠ¤í•œë†ˆë“¤ ë§¤ì¶œ ëŒ€ì‹œë³´ë“œ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f8fafc;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            text-align: center;
        }
        
        .header h1 {
            color: #1f2937;
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }
        
        .login-section {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .login-section.hidden {
            display: none;
        }
        
        .dashboard-section {
            display: none;
        }
        
        .dashboard-section.visible {
            display: block;
        }
        
        .input-group {
            margin-bottom: 1rem;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #374151;
            font-weight: 500;
        }
        
        .input-group input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 1rem;
        }
        
        .btn {
            background: #3b82f6;
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            width: 100%;
        }
        
        .btn:hover {
            background: #2563eb;
        }
        
        .error {
            color: #dc2626;
            margin-top: 0.5rem;
            text-align: center;
        }
        
        .nav {
            background: white;
            padding: 1rem 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .nav-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .nav select, .nav input {
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
        }
        
        .logout-btn {
            background: #ef4444;
            color: white;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }
        
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .kpi-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .kpi-card h3 {
            color: #6b7280;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
        }
        
        .kpi-card .value {
            color: #1f2937;
            font-size: 1.8rem;
            font-weight: bold;
        }
        
        .chart-section {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        
        .chart-container {
            position: relative;
            height: 350px;
            margin-top: 1rem;
        }
        
        .month-table {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow-x: auto;
        }
        
        .month-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .month-nav {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        
        .month-nav button {
            background: #f3f4f6;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            padding: 0.25rem 0.5rem;
            cursor: pointer;
        }
        
        .month-nav button:hover {
            background: #e5e7eb;
        }
        
        .month-nav .current-month {
            font-weight: bold;
            color: #1f2937;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }
        
        th, td {
            padding: 0.5rem;
            text-align: right;
            border-bottom: 1px solid #e5e7eb;
            white-space: nowrap;
        }
        
        th {
            background: #f9fafb;
            font-weight: 600;
            position: sticky;
            top: 0;
            text-align: center;
        }
        
        th:first-child, td:first-child {
            text-align: center;
            background: #f9fafb;
            position: sticky;
            left: 0;
            z-index: 10;
        }
        
        .day-column {
            min-width: 80px;
        }
        
        .total-row {
            background: #f3f4f6;
            font-weight: bold;
        }
        
        .status {
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 6px;
            text-align: center;
        }
        
        .status.success {
            background: #dcfce7;
            color: #15803d;
            border: 1px solid #bbf7d0;
        }
        
        .status.loading {
            background: #fef3c7;
            color: #d97706;
            border: 1px solid #fcd34d;
        }
        
        .status.error {
            background: #fee2e2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .nav {
                flex-direction: column;
                gap: 1rem;
            }
            
            .nav-controls {
                width: 100%;
                justify-content: center;
            }
            
            table {
                font-size: 0.8rem;
            }
            
            th, td {
                padding: 0.3rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¢ ë”°ìŠ¤í•œë†ˆë“¤ ë§¤ì¶œ ëŒ€ì‹œë³´ë“œ</h1>
            <p>ê³„ì—´ì‚¬ ë§¤ì¶œ ë°ì´í„°ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ë¶„ì„í•˜ê³  ì‹œê°í™”í•˜ëŠ” í†µí•© ëŒ€ì‹œë³´ë“œ</p>
        </div>

        <!-- ë¡œê·¸ì¸ ì„¹ì…˜ -->
        <div id="login-section" class="login-section">
            <h2 style="text-align: center; margin-bottom: 1.5rem;">ë¡œê·¸ì¸</h2>
            <div class="input-group">
                <label for="username">ì•„ì´ë””</label>
                <input type="text" id="username" placeholder="ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
            </div>
            <div class="input-group">
                <label for="password">ë¹„ë°€ë²ˆí˜¸</label>
                <input type="password" id="password" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
            </div>
            <button class="btn" onclick="login()">ë¡œê·¸ì¸</button>
            <div id="login-error" class="error"></div>
        </div>

        <!-- ëŒ€ì‹œë³´ë“œ ì„¹ì…˜ -->
        <div id="dashboard-section" class="dashboard-section">
            <!-- ë„¤ë¹„ê²Œì´ì…˜ -->
            <div class="nav">
                <div class="nav-controls">
                    <label for="affiliate-select">ê³„ì—´ì‚¬: </label>
                    <select id="affiliate-select" onchange="changeAffiliate()">
                        <option value="MRS">ì— ì•Œì—ìŠ¤</option>
                        <option value="APGUJEONG">ì••êµ¬ì •ê³±ì°½</option>
                        <option value="GEUKJIN">ê·¹ì§„ì´ì•¤ì§€</option>
                    </select>
                    <div class="nav-links" style="margin-top: 15px;">
                        <a href="dashboard/mrs/index.html" class="link-btn" style="display: inline-block; padding: 8px 12px; margin-right: 10px; background: #4f46e5; color: white; text-decoration: none; border-radius: 4px;">ì— ì•Œì—ìŠ¤ ëŒ€ì‹œë³´ë“œ</a>
                        <a href="dashboard/apgujeong/index.html" class="link-btn" style="display: inline-block; padding: 8px 12px; margin-right: 10px; background: #4f46e5; color: white; text-decoration: none; border-radius: 4px;">ì••êµ¬ì •ê³±ì°½ ëŒ€ì‹œë³´ë“œ</a>
                        <a href="dashboard/geukjin/index.html" class="link-btn" style="display: inline-block; padding: 8px 12px; background: #4f46e5; color: white; text-decoration: none; border-radius: 4px;">ê·¹ì§„ì´ì•¤ì§€ ëŒ€ì‹œë³´ë“œ</a>
                    </div>
                </div>
                <button class="logout-btn" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
            </div>

            <!-- ìƒíƒœ í‘œì‹œ -->
            <div id="status" class="status loading">
                ğŸ“Š ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ê³  ìˆìŠµë‹ˆë‹¤...
            </div>

            <!-- KPI ì¹´ë“œ -->
            <div class="kpi-grid" id="kpi-grid">
                <!-- KPI ì¹´ë“œë“¤ì´ ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
            </div>

            <!-- ì°¨íŠ¸ ì„¹ì…˜ -->
            <div class="charts-grid" id="charts-section">
                <!-- ì°¨íŠ¸ë“¤ì´ ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
            </div>

            <!-- ì›”ê°„ ë°ì´í„° í…Œì´ë¸” -->
            <div class="month-table">
                <div class="month-header">
                    <h3 id="table-title">ì›”ê°„ ë§¤ì¶œ ë°ì´í„°</h3>
                    <div class="month-nav">
                        <button onclick="changeMonth(-1)">â—€</button>
                        <span class="current-month" id="current-month">2025ë…„ 5ì›”</span>
                        <button onclick="changeMonth(1)">â–¶</button>
                    </div>
                </div>
                <table id="month-data-table">
                    <thead id="table-header">
                        <!-- í—¤ë”ê°€ ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
                    </thead>
                    <tbody id="table-body">
                        <tr>
                            <td colspan="100%" style="text-align: center; color: #6b7280;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ê³  ìˆìŠµë‹ˆë‹¤...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Supabase í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
        const SUPABASE_URL = 'https://ooqexropurnslqmcbjqk.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9vcWV4cm9wdXJuc2xxbWNiamxxayIsInJvbGUiOiJhbm9uIiwiaWF0IjoxNzQ3NDc0MjA1LCJleHAiOjIwNjMwNTAyMDV9.yXVabxtZwX3QFF6xnjmj5VI2Lrp_7fZ3HvS5dCalbA';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        let currentAffiliate = 'MRS';
        let currentYear = 2025;
        let currentMonth = 5; // 5ì›”
        let salesChart = null;
        let channelChart = null;

        // ê³„ì—´ì‚¬ë³„ ì„¤ì •
        const affiliateConfigs = {
            'MRS': {
                name: 'ì— ì•Œì—ìŠ¤',
                type: 'online',
                kpis: ['ì´ ë§¤ì¶œ', 'ì¿ íŒ¡ë¡œì¼“ ë§¤ì¶œ', 'ìŠ¤ë§ˆíŠ¸ìŠ¤í† ì–´ ë§¤ì¶œ', 'í™˜ë¶ˆì•¡'],
                fields: {
                    main: ['coupang_rocket', 'smart_store', 'coupang_wing', 'other_online', 'wholesale', 'export'],
                    display: ['ì¿ íŒ¡ë¡œì¼“', 'ìŠ¤ë§ˆíŠ¸ìŠ¤í† ì–´', 'ì¿ íŒ¡ìœ™', 'ê¸°íƒ€ì˜¨ë¼ì¸', 'ë„ë§¤', 'ìˆ˜ì¶œ', 'ì´ë§¤ì¶œ', 'í™˜ë¶ˆì•¡', 'ì£¼ë¬¸ìˆ˜', 'íŠ¹ì´ì‚¬í•­']
                },
                chartConfig: {
                    channels: [
                        { key: 'coupang_rocket', label: 'ì¿ íŒ¡ë¡œì¼“', color: '#ff6b6b' },
                        { key: 'smart_store', label: 'ìŠ¤ë§ˆíŠ¸ìŠ¤í† ì–´', color: '#4ecdc4' },
                        { key: 'coupang_wing', label: 'ì¿ íŒ¡ìœ™', color: '#45b7d1' },
                        { key: 'other_online', label: 'ê¸°íƒ€ì˜¨ë¼ì¸', color: '#96ceb4' },
                        { key: 'wholesale', label: 'ë„ë§¤', color: '#feca57' },
                        { key: 'export', label: 'ìˆ˜ì¶œ', color: '#ff9ff3' }
                    ]
                }
            },
            'APGUJEONG': {
                name: 'ì••êµ¬ì •ê³±ì°½',
                type: 'restaurant',
                kpis: ['ì¼ì¼ í‰ê· ë§¤ì¶œ', 'ê³ ê° ìˆ˜', 'í…Œì´ë¸”íšŒì „ìœ¨', 'ì¹´ë“œ ë§¤ì¶œ'],
                fields: {
                    main: ['card_sales', 'cash_sales', 'delivery_sales'],
                    display: ['ìš”ì¼', 'ì¹´ë“œë§¤ì¶œ', 'í˜„ê¸ˆë§¤ì¶œ', 'ë°°ë‹¬ë§¤ì¶œ', 'ì´ë§¤ì¶œ', 'ê³ ê°ìˆ˜', 'í…Œì´ë¸”íšŒì „ìœ¨', 'í˜„ê¸ˆì…ê¸ˆ', 'í˜„ê¸ˆì§€ì¶œ', 'íŠ¹ì´ì‚¬í•­']
                }
            },
            'GEUKJIN': {
                name: 'ê·¹ì§„ì´ì•¤ì§€',
                type: 'energy',
                kpis: ['ì´ ë§¤ì¶œ', 'ì´ ë§ˆì§„', 'ë§ˆì§„ìœ¨', 'ì„±ì¥ë¥ '],
                fields: {
                    main: ['gasoline_sales', 'diesel_sales', 'kerosene_sales', 'freight_sales'],
                    display: ['íœ˜ë°œìœ ë§¤ì¶œ', 'ê²½ìœ ë§¤ì¶œ', 'ë“±ìœ ë§¤ì¶œ', 'í™”ë¬¼ë§¤ì¶œ', 'ì´ë§¤ì¶œ', 'ì´ì›ê°€', 'ì´ë§ˆì§„', 'ì„±ì¥ë¥ ', 'íŠ¹ì´ì‚¬í•­']
                }
            }
        };

        // ë¡œê·¸ì¸ í•¨ìˆ˜
        function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('login-error');

            if (username === 'Warmguys' && password === 'Eksha12!@') {
                localStorage.setItem('isLoggedIn', 'true');
                localStorage.setItem('loginTime', Date.now().toString());
                
                document.getElementById('login-section').classList.add('hidden');
                document.getElementById('dashboard-section').classList.add('visible');
                
                loadDashboard();
            } else {
                errorDiv.textContent = 'ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.';
            }
        }

        // ë¡œê·¸ì•„ì›ƒ í•¨ìˆ˜
        function logout() {
            localStorage.removeItem('isLoggedIn');
            localStorage.removeItem('loginTime');
            
            document.getElementById('login-section').classList.remove('hidden');
            document.getElementById('dashboard-section').classList.remove('visible');
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
        window.onload = function() {
            const isLoggedIn = localStorage.getItem('isLoggedIn');
            const loginTime = localStorage.getItem('loginTime');
            
            if (isLoggedIn && loginTime) {
                const elapsed = Date.now() - parseInt(loginTime);
                if (elapsed > 24 * 60 * 60 * 1000) {
                    logout();
                    return;
                }
                
                document.getElementById('login-section').classList.add('hidden');
                document.getElementById('dashboard-section').classList.add('visible');
                loadDashboard();
            }
        };

        // ëŒ€ì‹œë³´ë“œ ë¡œë“œ
        async function loadDashboard() {
            try {
                document.getElementById('status').className = 'status loading';
                document.getElementById('status').textContent = 'ğŸ“Š ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ê³  ìˆìŠµë‹ˆë‹¤...';
                
                await loadSalesData();
                
                document.getElementById('status').className = 'status success';
                document.getElementById('status').textContent = 'âœ… ë°ì´í„° ë¡œë“œ ì™„ë£Œ!';
            } catch (error) {
                console.error('Error loading dashboard:', error);
                document.getElementById('status').className = 'status error';
                document.getElementById('status').textContent = 'âŒ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ' + error.message;
            }
        }

        // ë§¤ì¶œ ë°ì´í„° ë¡œë“œ (í†µí•© í…Œì´ë¸”ì—ì„œ)
        async function loadSalesData() {
            const { data, error } = await supabase
                .from('sales_data')
                .select('*')
                .eq('affiliate_key', currentAffiliate)
                .order('date', { ascending: true });

            if (error) throw error;

            updateDashboardLayout();
            updateKPIs(data);
            updateCharts(data);
            updateMonthlyTable(data);
        }

        // ëŒ€ì‹œë³´ë“œ ë ˆì´ì•„ì›ƒ ì—…ë°ì´íŠ¸
        function updateDashboardLayout() {
            const config = affiliateConfigs[currentAffiliate];
            
            // KPI ì¹´ë“œ ìƒì„±
            const kpiGrid = document.getElementById('kpi-grid');
            kpiGrid.innerHTML = '';
            
            config.kpis.forEach((kpi, index) => {
                const kpiCard = document.createElement('div');
                kpiCard.className = 'kpi-card';
                kpiCard.innerHTML = `
                    <h3>${kpi}</h3>
                    <div class="value" id="kpi-${index}">-</div>
                `;
                kpiGrid.appendChild(kpiCard);
            });

            // ì°¨íŠ¸ ì„¹ì…˜ ìƒì„±
            const chartsSection = document.getElementById('charts-section');
            chartsSection.innerHTML = '';
            
            if (currentAffiliate === 'MRS') {
                chartsSection.innerHTML = `
                    <div class="chart-section">
                        <h3>ì±„ë„ë³„ ë§¤ì¶œ ì¶”ì´</h3>
                        <div class="chart-container">
                            <canvas id="sales-chart"></canvas>
                        </div>
                    </div>
                    <div class="chart-section">
                        <h3>ì±„ë„ë³„ ë§¤ì¶œ ë¹„ìœ¨</h3>
                        <div class="chart-container">
                            <canvas id="channel-chart"></canvas>
                        </div>
                    </div>
                `;
            } else {
                chartsSection.innerHTML = `
                    <div class="chart-section" style="grid-column: 1/-1;">
                        <h3>ë§¤ì¶œ ì¶”ì´</h3>
                        <div class="chart-container">
                            <canvas id="sales-chart"></canvas>
                        </div>
                    </div>
                `;
            }

            // í…Œì´ë¸” ì œëª© ì—…ë°ì´íŠ¸
            document.getElementById('table-title').textContent = `${config.name} ì›”ê°„ ë§¤ì¶œ ë°ì´í„°`;
        }

        // KPI ì—…ë°ì´íŠ¸
        function updateKPIs(data) {
            if (!data || data.length === 0) return;

            const config = affiliateConfigs[currentAffiliate];

            switch(currentAffiliate) {
                case 'MRS':
                    updateMRSKPIs(data);
                    break;
                case 'APGUJEONG':
                    updateAPGUJEONGKPIs(data);
                    break;
                case 'GEUKJIN':
                    updateGEUKJINKPIs(data);
                    break;
            }
        }

        function updateMRSKPIs(data) {
            const totalSales = data.reduce((sum, row) => sum + (parseFloat(row.total_sales) || 0), 0);
            const coupangRocketSales = data.reduce((sum, row) => sum + (parseFloat(row.coupang_rocket) || 0), 0);
            const smartStoreSales = data.reduce((sum, row) => sum + (parseFloat(row.smart_store) || 0), 0);
            const totalRefund = data.reduce((sum, row) => sum + (parseFloat(row.refund_amount) || 0), 0);

            document.getElementById('kpi-0').textContent = formatCurrency(totalSales);
            document.getElementById('kpi-1').textContent = formatCurrency(coupangRocketSales);
            document.getElementById('kpi-2').textContent = formatCurrency(smartStoreSales);
            document.getElementById('kpi-3').textContent = formatCurrency(totalRefund);
        }

        function updateAPGUJEONGKPIs(data) {
            const totalSales = data.reduce((sum, row) => sum + (parseFloat(row.total_sales) || 0), 0);
            const avgSales = totalSales / data.length;
            const totalCustomers = data.reduce((sum, row) => sum + (parseInt(row.customer_count) || 0), 0);
            const avgTurnover = data.reduce((sum, row) => sum + (parseFloat(row.table_turnover) || 0), 0) / data.length;
            const cardSales = data.reduce((sum, row) => sum + (parseFloat(row.card_sales) || 0), 0);

            document.getElementById('kpi-0').textContent = formatCurrency(avgSales);
            document.getElementById('kpi-1').textContent = totalCustomers.toLocaleString() + 'ëª…';
            document.getElementById('kpi-2').textContent = avgTurnover.toFixed(1) + 'íšŒ';
            document.getElementById('kpi-3').textContent = formatCurrency(cardSales);
        }

        function updateGEUKJINKPIs(data) {
            const totalSales = data.reduce((sum, row) => sum + (parseFloat(row.total_sales) || 0), 0);
            const totalMargin = data.reduce((sum, row) => sum + (parseFloat(row.total_margin) || 0), 0);
            const marginRate = totalSales > 0 ? (totalMargin / totalSales * 100) : 0;
            const avgGrowthRate = data.reduce((sum, row) => sum + (parseFloat(row.growth_rate) || 0), 0) / data.length;

            document.getElementById('kpi-0').textContent = formatCurrency(totalSales);
            document.getElementById('kpi-1').textContent = formatCurrency(totalMargin);
            document.getElementById('kpi-2').textContent = marginRate.toFixed(1) + '%';
            document.getElementById('kpi-3').textContent = '+' + avgGrowthRate.toFixed(1) + '%';
        }

        // ì°¨íŠ¸ ì—…ë°ì´íŠ¸
        function updateCharts(data) {
            if (currentAffiliate === 'MRS') {
                updateMRSCharts(data);
            } else {
                updateDefaultChart(data);
            }
        }

        function updateMRSCharts(data) {
            // ì±„ë„ë³„ ë§¤ì¶œ ì¶”ì´ ì°¨íŠ¸
            const salesCtx = document.getElementById('sales-chart');
            if (salesChart) {
                salesChart.destroy();
            }

            const labels = data.map(row => new Date(row.date).toLocaleDateString('ko-KR'));
            const config = affiliateConfigs['MRS'];
            const datasets = config.chartConfig.channels.map(channel => ({
                label: channel.label,
                data: data.map(row => parseFloat(row[channel.key]) || 0),
                borderColor: channel.color,
                backgroundColor: channel.color + '20',
                tension: 0.4
            }));

            salesChart = new Chart(salesCtx, {
                type: 'line',
                data: { labels, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    }
                }
            });

            // ì±„ë„ë³„ ë§¤ì¶œ ë¹„ìœ¨ ì°¨íŠ¸
            const channelCtx = document.getElementById('channel-chart');
            if (channelChart) {
                channelChart.destroy();
            }

            const channelTotals = config.chartConfig.channels.map(channel => ({
                label: channel.label,
                value: data.reduce((sum, row) => sum + (parseFloat(row[channel.key]) || 0), 0),
                color: channel.color
            }));

            channelChart = new Chart(channelCtx, {
                type: 'doughnut',
                data: {
                    labels: channelTotals.map(item => item.label),
                    datasets: [{
                        data: channelTotals.map(item => item.value),
                        backgroundColor: channelTotals.map(item => item.color),
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function updateDefaultChart(data) {
            const ctx = document.getElementById('sales-chart');
            if (salesChart) {
                salesChart.destroy();
            }

            const labels = data.map(row => new Date(row.date).toLocaleDateString('ko-KR'));
            const salesData = data.map(row => parseFloat(row.total_sales) || 0);

            salesChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ì´ ë§¤ì¶œ',
                        data: salesData,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        // ì›”ê°„ í…Œì´ë¸” ì—…ë°ì´íŠ¸
        function updateMonthlyTable(data) {
            const config = affiliateConfigs[currentAffiliate];
            
            // í˜„ì¬ ì›” ë°ì´í„° í•„í„°ë§
            const monthData = data.filter(row => {
                const date = new Date(row.date);
                return date.getFullYear() === currentYear && (date.getMonth() + 1) === currentMonth;
            });

            // í—¤ë” ìƒì„±
            const thead = document.getElementById('table-header');
            thead.innerHTML = '';
            const headerRow = document.createElement('tr');
            
            const dayHeader = document.createElement('th');
            dayHeader.textContent = 'ì¼';
            dayHeader.style.position = 'sticky';
            dayHeader.style.left = '0';
            dayHeader.style.zIndex = '11';
            headerRow.appendChild(dayHeader);
            
            config.fields.display.forEach(field => {
                const th = document.createElement('th');
                th.textContent = field;
                th.className = 'day-column';
                headerRow.appendChild(th);
            });
            
            thead.appendChild(headerRow);

            // ì›”ê°„ ë°ì´í„° í…Œì´ë¸” ìƒì„± (1ì¼ë¶€í„° 31ì¼ê¹Œì§€)
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';
            
            const daysInMonth = new Date(currentYear, currentMonth, 0).getDate();
            let monthTotals = {};
            
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${currentYear}-${String(currentMonth).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayData = monthData.find(row => row.date === dateStr);
                
                const tr = document.createElement('tr');
                
                // ì¼ì ì»¬ëŸ¼
                const dayTd = document.createElement('td');
                dayTd.textContent = day + 'ì¼';
                dayTd.style.position = 'sticky';
                dayTd.style.left = '0';
                dayTd.style.background = '#f9fafb';
                dayTd.style.zIndex = '10';
                tr.appendChild(dayTd);
                
                // ë°ì´í„° ì»¬ëŸ¼ë“¤
                config.fields.display.forEach(field => {
                    const td = document.createElement('td');
                    let value = '-';
                    
                    if (dayData) {
                        const dbField = getDbFieldName(field, currentAffiliate);
                        value = dayData[dbField] || '-';
                        
                        if (field.includes('ë§¤ì¶œ') || field.includes('ì›ê°€') || field.includes('ë§ˆì§„') || field.includes('í• ì¸') || field.includes('ì…ê¸ˆ') || field.includes('ì§€ì¶œ')) {
                            if (value !== '-') {
                                const numValue = parseFloat(value) || 0;
                                value = formatCurrency(numValue);
                                
                                // ì›” í•©ê³„ ê³„ì‚°
                                if (!monthTotals[field]) monthTotals[field] = 0;
                                monthTotals[field] += numValue;
                            }
                        } else if (field.includes('ìˆ˜') || field.includes('íšŒì „ìœ¨')) {
                            if (value !== '-') {
                                value = (parseFloat(value) || 0).toLocaleString();
                            }
                        } else if (field === 'ì„±ì¥ë¥ ') {
                            if (value !== '-') {
                                value = (parseFloat(value) || 0).toFixed(1) + '%';
                            }
                        }
                    }
                    
                    td.textContent = value;
                    tr.appendChild(td);
                });
                
                tbody.appendChild(tr);
            }
            
            // ì›” í•©ê³„ í–‰ ì¶”ê°€
            const totalRow = document.createElement('tr');
            totalRow.className = 'total-row';
            
            const totalDayTd = document.createElement('td');
            totalDayTd.textContent = 'ì›” í•©ê³„';
            totalDayTd.style.position = 'sticky';
            totalDayTd.style.left = '0';
            totalDayTd.style.background = '#f3f4f6';
            totalDayTd.style.zIndex = '10';
            totalRow.appendChild(totalDayTd);
            
            config.fields.display.forEach(field => {
                const td = document.createElement('td');
                if (monthTotals[field]) {
                    td.textContent = formatCurrency(monthTotals[field]);
                } else {
                    td.textContent = '-';
                }
                totalRow.appendChild(td);
            });
            
            tbody.appendChild(totalRow);
        }

        // í‘œì‹œëª…ì„ DB í•„ë“œëª…ìœ¼ë¡œ ë³€í™˜
        function getDbFieldName(displayName, affiliate) {
            const mappings = {
                'MRS': {
                    'ì¿ íŒ¡ë¡œì¼“': 'coupang_rocket',
                    'ìŠ¤ë§ˆíŠ¸ìŠ¤í† ì–´': 'smart_store',
                    'ì¿ íŒ¡ìœ™': 'coupang_wing',
                    'ê¸°íƒ€ì˜¨ë¼ì¸': 'other_online',
                    'ë„ë§¤': 'wholesale',
                    'ìˆ˜ì¶œ': 'export',
                    'ì´ë§¤ì¶œ': 'total_sales',
                    'í™˜ë¶ˆì•¡': 'refund_amount',
                    'ì£¼ë¬¸ìˆ˜': 'order_count',
                    'íŠ¹ì´ì‚¬í•­': 'notes'
                },
                'APGUJEONG': {
                    'ìš”ì¼': 'day_of_week',
                    'ì¹´ë“œë§¤ì¶œ': 'card_sales',
                    'í˜„ê¸ˆë§¤ì¶œ': 'cash_sales',
                    'ë°°ë‹¬ë§¤ì¶œ': 'delivery_sales',
                    'ì´ë§¤ì¶œ': 'total_sales',
                    'ê³ ê°ìˆ˜': 'customer_count',
                    'í…Œì´ë¸”íšŒì „ìœ¨': 'table_turnover',
                    'í˜„ê¸ˆì…ê¸ˆ': 'cash_deposit',
                    'í˜„ê¸ˆì§€ì¶œ': 'cash_expense',
                    'íŠ¹ì´ì‚¬í•­': 'special_notes'
                },
                'GEUKJIN': {
                    'íœ˜ë°œìœ ë§¤ì¶œ': 'gasoline_sales',
                    'ê²½ìœ ë§¤ì¶œ': 'diesel_sales',
                    'ë“±ìœ ë§¤ì¶œ': 'kerosene_sales',
                    'í™”ë¬¼ë§¤ì¶œ': 'freight_sales',
                    'ì´ë§¤ì¶œ': 'total_sales',
                    'ì´ì›ê°€': 'total_cost',
                    'ì´ë§ˆì§„': 'total_margin',
                    'ì„±ì¥ë¥ ': 'growth_rate',
                    'íŠ¹ì´ì‚¬í•­': 'notes'
                }
            };
            
            return mappings[affiliate]?.[displayName] || displayName.toLowerCase();
        }

        // ê³„ì—´ì‚¬ ë³€ê²½
        function changeAffiliate() {
            currentAffiliate = document.getElementById('affiliate-select').value;
            loadDashboard();
        }

        // ì›” ë³€ê²½
        function changeMonth(direction) {
            currentMonth += direction;
            if (currentMonth > 12) {
                currentMonth = 1;
                currentYear++;
            } else if (currentMonth < 1) {
                currentMonth = 12;
                currentYear--;
            }
            
            document.getElementById('current-month').textContent = `${currentYear}ë…„ ${currentMonth}ì›”`;
            loadDashboard();
        }

        // í†µí™” í¬ë§·
        function formatCurrency(amount) {
            return new Intl.NumberFormat('ko-KR', { 
                style: 'currency', 
                currency: 'KRW' 
            }).format(amount);
        }

        // Enter í‚¤ë¡œ ë¡œê·¸ì¸
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !document.getElementById('login-section').classList.contains('hidden')) {
                login();
            }
        });
    </script>
</body>
</html>